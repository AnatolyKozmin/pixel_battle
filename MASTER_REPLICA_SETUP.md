# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Master/Replica –¥–ª—è PostgreSQL

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ

–°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ master/replica —á–µ—Ä–µ–∑ pgbouncer:

1. **–î–≤–∞ engine**: `master_engine` (–∑–∞–ø–∏—Å—å) –∏ `replica_engine` (—á—Ç–µ–Ω–∏–µ)
2. **–î–≤–µ —Å–µ—Å—Å–∏–∏**: `MasterSessionLocal` –∏ `ReplicaSessionLocal`
3. **–î–≤–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**: `get_db()` (master) –∏ `get_db_read()` (replica)

## üìã –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ `.env` —Ñ–∞–π–ª:

```bash
# Master (–¥–ª—è –∑–∞–ø–∏—Å–∏) - —á–µ—Ä–µ–∑ pgbouncer
DATABASE_URL=postgresql+asyncpg://user:pass@pgbouncer:6432/pixel_battle?server_settings=application_name=master

# Replica (–¥–ª—è —á—Ç–µ–Ω–∏—è) - —á–µ—Ä–µ–∑ pgbouncer
DATABASE_REPLICA_URL=postgresql+asyncpg://user:pass@pgbouncer:6432/pixel_battle?server_settings=application_name=replica
```

**–í–∞–∂–Ω–æ**: 
- –ï—Å–ª–∏ `DATABASE_REPLICA_URL` –Ω–µ —É–∫–∞–∑–∞–Ω, —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `DATABASE_URL` –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
- –û–±–∞ URL –¥–æ–ª–∂–Ω—ã —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ pgbouncer, –∫–æ—Ç–æ—Ä—ã–π —Å–∞–º –Ω–∞–ø—Ä–∞–≤–∏—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ master/replica

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –û–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞–ø–∏—Å–∏ (–∏—Å–ø–æ–ª—å–∑—É—é—Ç master):
- ‚úÖ –†–∞–∑–º–µ—â–µ–Ω–∏–µ –ø–∏–∫—Å–µ–ª–µ–π (`POST /api/pixels/`)
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ INSERT/UPDATE/DELETE

### –û–ø–µ—Ä–∞—Ü–∏–∏ —á—Ç–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É—é—Ç replica):
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ —Ö–æ–ª—Å—Ç–∞ (`GET /api/canvas/`)
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (`GET /api/canvas/stats`)
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∏–∫—Å–µ–ª—è (`GET /api/pixels/{x}/{y}`)
- ‚úÖ –ê–Ω–∞–ª–∏–∑ —Ö–æ–ª—Å—Ç–∞ —á–µ—Ä–µ–∑ AI (`POST /api/ai/analyze`)
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ (`GET /api/users/me`)

## üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- **–ß—Ç–µ–Ω–∏–µ —Ö–æ–ª—Å—Ç–∞** (—Å–∞–º–∞—è —á–∞—Å—Ç–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è) ‚Üí replica (–Ω–µ –Ω–∞–≥—Ä—É–∂–∞–µ—Ç master)
- **–ó–∞–ø–∏—Å—å –ø–∏–∫—Å–µ–ª–µ–π** ‚Üí master (–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)
- **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏**: —á—Ç–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö

### –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ replica –¥–ª—è –µ—â–µ –±–æ–ª—å—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- Master –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω –æ—Ç –Ω–∞–≥—Ä—É–∑–∫–∏ —á—Ç–µ–Ω–∏—è
- –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å

## üéØ –û–∂–∏–¥–∞–µ–º—ã–π –ø—Ä–∏—Ä–æ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ë–µ–∑ replica:
- ~200-500 –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ~20-50 —Ä–∞–∑–º–µ—â–µ–Ω–∏–π –ø–∏–∫—Å–µ–ª–µ–π –≤ —Å–µ–∫—É–Ω–¥—É

### –° replica:
- **~500-1000 –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** (2x —É–ª—É—á—à–µ–Ω–∏–µ)
- **~50-100 —Ä–∞–∑–º–µ—â–µ–Ω–∏–π –ø–∏–∫—Å–µ–ª–µ–π –≤ —Å–µ–∫—É–Ω–¥—É** (2x —É–ª—É—á—à–µ–Ω–∏–µ)
- **–ß—Ç–µ–Ω–∏–µ —Ö–æ–ª—Å—Ç–∞ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø–∏—Å—å**

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ pgbouncer

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ pgbouncer –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ:

### pgbouncer.ini:
```ini
[databases]
pixel_battle_master = host=postgres-master port=5432 dbname=pixel_battle
pixel_battle_replica = host=postgres-replica port=5432 dbname=pixel_battle

[pgbouncer]
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 25
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:
- `DATABASE_URL` ‚Üí –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ `pixel_battle_master` —á–µ—Ä–µ–∑ pgbouncer
- `DATABASE_REPLICA_URL` ‚Üí –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ `pixel_battle_replica` —á–µ—Ä–µ–∑ pgbouncer

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π:

```python
# –í –∫–æ–¥–µ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –∫–∞–∫–æ–π engine –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
from app.core.database import master_engine, replica_engine

# –ü—Ä–æ–≤–µ—Ä–∫–∞ master
async with master_engine.connect() as conn:
    result = await conn.execute(text("SELECT current_setting('application_name')"))
    print(f"Master: {result.scalar()}")

# –ü—Ä–æ–≤–µ—Ä–∫–∞ replica
async with replica_engine.connect() as conn:
    result = await conn.execute(text("SELECT current_setting('application_name')"))
    print(f"Replica: {result.scalar()}")
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π engine:
- –ó–∞–ø–∏—Å—å ‚Üí master
- –ß—Ç–µ–Ω–∏–µ ‚Üí replica

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **Replication lag**: Replica –º–æ–∂–µ—Ç –æ—Ç—Å—Ç–∞–≤–∞—Ç—å –æ—Ç master –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥. –î–ª—è —á—Ç–µ–Ω–∏—è —Ö–æ–ª—Å—Ç–∞ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ.

2. **Fallback**: –ï—Å–ª–∏ `DATABASE_REPLICA_URL` –Ω–µ —É–∫–∞–∑–∞–Ω, –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–¥—É—Ç —á–µ—Ä–µ–∑ master (–±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ–∂–∏–º).

3. **Connection pooling**: –û–±–∞ engine –∏—Å–ø–æ–ª—å–∑—É—é—Ç connection pooling —á–µ—Ä–µ–∑ pgbouncer.

4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –°–ª–µ–¥–∏—Ç–µ –∑–∞ –Ω–∞–≥—Ä—É–∑–∫–æ–π –Ω–∞ master –∏ replica –æ—Ç–¥–µ–ª—å–Ω–æ.

## üöÄ –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–ù–µ—Å–∫–æ–ª—å–∫–æ replica**: –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ replica –¥–ª—è –µ—â–µ –±–æ–ª—å—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
2. **Read-after-write consistency**: –î–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å master –¥–∞–∂–µ –¥–ª—è —á—Ç–µ–Ω–∏—è
3. **Health checks**: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ replica
4. **Automatic failover**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ master –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ replica
