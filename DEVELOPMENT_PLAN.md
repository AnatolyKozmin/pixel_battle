# План разработки Pixel Battle

## Архитектура решения

### Backend (FastAPI)
- **FastAPI** - основной фреймворк для API
- **WebSocket** - real-time обновления холста
- **PostgreSQL** - основное хранилище данных (пиксели, пользователи)
- **Redis** - кеширование и pub/sub для синхронизации между инстансами
- **Alembic** - миграции БД
- **SQLAlchemy** - ORM
- **asyncpg** - асинхронный драйвер PostgreSQL
- **aioredis** - асинхронный Redis клиент

### Frontend (Vue.js)
- **Vue 3** - фронтенд фреймворк
- **Canvas API** - отрисовка пикселей
- **WebSocket Client** - подключение к серверу
- **Telegram Web App SDK** - интеграция с Telegram

### Telegram
- **Telegram Bot** - авторизация и уведомления
- **Telegram Mini App** - веб-интерфейс игры

## Оптимизации для производительности

### 1. База данных
- **Индексы**: Составной индекс на (x, y) для быстрого поиска пикселей
- **Connection Pooling**: Использование pgbouncer (уже настроен)
- **Асинхронные запросы**: asyncpg для неблокирующих операций
- **Пакетные запросы**: Загрузка холста частями при необходимости

### 2. Redis
- **Кеширование**: Кеш всего холста на 5 минут
- **Pub/Sub**: Синхронизация обновлений между инстансами
- **Инвалидация кеша**: При размещении нового пикселя

### 3. WebSocket
- **Одна подписка на Redis**: Глобальная подписка для всех клиентов
- **Broadcast**: Рассылка обновлений всем подключенным клиентам
- **Автоматическое переподключение**: На клиенте

### 4. Rate Limiting
- **SlowAPI**: Ограничение 10 запросов в минуту на размещение пикселя
- **Кулдаун**: 5 секунд между размещениями пикселей (настраивается)

### 5. Масштабирование
- **Горизонтальное масштабирование**: Через Redis pub/sub
- **Stateless API**: Все состояние в БД и Redis
- **WebSocket**: Каждый инстанс управляет своими подключениями

## Этапы разработки

### ✅ Этап 1: Базовая структура проекта
- [x] Создание структуры проекта
- [x] Настройка FastAPI
- [x] Настройка PostgreSQL (модели, миграции)
- [x] Настройка Redis
- [x] Базовые API endpoints

### ✅ Этап 2: Backend функциональность
- [x] Модели данных (User, Pixel)
- [x] Сервисы (PixelService, UserService)
- [x] API роуты (pixels, users, canvas)
- [x] WebSocket для real-time обновлений
- [x] Redis pub/sub для синхронизации
- [x] Rate limiting и кулдаун

### ✅ Этап 3: Интеграция с Telegram
- [x] Авторизация через Telegram Mini App
- [x] Telegram Bot (базовая структура)
- [x] Верификация initData

### ✅ Этап 4: Frontend
- [x] Vue.js приложение
- [x] Canvas для отрисовки
- [x] WebSocket клиент
- [x] Интеграция с Telegram Web App SDK
- [x] UI компоненты

### ⏳ Этап 5: Оптимизация и доработка
- [ ] Тестирование под нагрузкой
- [ ] Оптимизация запросов к БД
- [ ] Улучшение UI/UX
- [ ] Обработка ошибок
- [ ] Логирование и мониторинг

### ⏳ Этап 6: Деплой
- [ ] Настройка production окружения
- [ ] Настройка Telegram Bot Webhook
- [ ] Настройка SSL для WebSocket
- [ ] Мониторинг и алерты

## Дополнительные инструменты (рекомендуемые)

### Мониторинг
- **Prometheus** + **Grafana** - метрики и дашборды
- **Sentry** - отслеживание ошибок
- **Loguru** - структурированное логирование

### Тестирование
- **pytest** + **pytest-asyncio** - unit и integration тесты
- **pytest-cov** - покрытие кода тестами
- **Locust** - нагрузочное тестирование

### CI/CD
- **GitHub Actions** / **GitLab CI** - автоматизация деплоя
- **Docker** + **Docker Compose** - контейнеризация

### Безопасность
- **HTTPS** - обязателен для Telegram Mini App
- **CORS** - настройка разрешенных источников
- **Rate Limiting** - защита от спама
- **Валидация данных** - Pydantic схемы

## Конфигурация для 1000 пользователей

### Рекомендуемые настройки

**PostgreSQL:**
- Connection pool: 20-30 соединений
- Max overflow: 10-20
- Использование pgbouncer (уже настроен)

**Redis:**
- Connection pool: 10-20 соединений
- TTL кеша: 5 минут
- Pub/Sub для синхронизации

**FastAPI:**
- Workers: 2-4 (зависит от CPU)
- Timeout: 30 секунд
- Max connections: 1000+

**WebSocket:**
- Max connections per instance: 500-1000
- Ping interval: 30 секунд
- Timeout: 60 секунд

## Следующие шаги

1. **Настройка окружения**
   - Создать `.env` файл с настройками
   - Настроить подключение к PostgreSQL и Redis
   - Получить токен Telegram Bot

2. **Запуск миграций**
   ```bash
   cd backend
   alembic upgrade head
   ```

3. **Запуск backend**
   ```bash
   uvicorn app.main:app --host 0.0.0.0 --port 8000
   ```

4. **Запуск frontend**
   ```bash
   cd frontend
   npm install
   npm run dev
   ```

5. **Настройка Telegram Bot**
   - Создать бота через @BotFather
   - Настроить Web App URL
   - Настроить Webhook (опционально)

6. **Тестирование**
   - Проверить размещение пикселей
   - Проверить real-time обновления
   - Проверить авторизацию через Telegram
