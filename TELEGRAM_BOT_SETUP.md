# Настройка Telegram бота для Pixel Battle

## Описание

Telegram бот для сбора пользователей и работы с командами. Бот позволяет:
- Регистрировать пользователей при команде `/start`
- Создавать команды и добавлять участников
- Управлять командами (просмотр, присоединение, выход)

## Команды бота

### Основные команды:
- `/start` - Регистрация пользователя в системе
- `/help` - Справка по всем командам
- `/stats` - Статистика пользователя

### Команды для работы с командами:
- `/create_team <название>` - Создать новую команду
- `/join_team <код>` - Присоединиться к команде по коду
- `/my_teams` - Показать все мои команды
- `/team_info <код>` - Информация о команде
- `/team_members <код>` - Список участников команды
- `/leave_team <код>` - Покинуть команду
- `/delete_team <код>` - Удалить команду (только владелец)

## Настройка

### 1. Получить токен бота

1. Открой [@BotFather](https://t.me/BotFather) в Telegram
2. Отправь команду `/newbot`
3. Следуй инструкциям и получи токен бота

### 2. Добавить токен в `.env`

```bash
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_WEBHOOK_URL=https://your-domain.com  # URL для кнопки "Открыть игру"
```

### 3. Применить миграцию базы данных

На сервере выполни:

```bash
cd ~/ct/pixel_battle
docker compose exec backend alembic upgrade head
```

Или локально:

```bash
cd backend
alembic upgrade head
```

Миграция создаст таблицы:
- `teams` - команды
- `team_members` - связь пользователей с командами (many-to-many)

### 4. Перезапустить backend

```bash
docker compose restart backend
```

Или пересобрать:

```bash
docker compose up -d --build backend
```

## Использование

### Примеры команд:

1. **Регистрация:**
   ```
   /start
   ```

2. **Создание команды:**
   ```
   /create_team Моя команда
   ```
   Бот вернёт уникальный код команды (например, `ABC123`)

3. **Присоединение к команде:**
   ```
   /join_team ABC123
   ```

4. **Просмотр моих команд:**
   ```
   /my_teams
   ```

5. **Информация о команде:**
   ```
   /team_info ABC123
   ```

6. **Список участников:**
   ```
   /team_members ABC123
   ```

## Структура базы данных

### Таблица `teams`:
- `id` - ID команды
- `name` - Название команды
- `code` - Уникальный код команды (6 символов)
- `owner_id` - ID владельца (FK на users.id)
- `description` - Описание команды (опционально)
- `created_at` - Дата создания

### Таблица `team_members`:
- `team_id` - ID команды (FK на teams.id)
- `user_id` - ID пользователя (FK на users.id)
- `joined_at` - Дата присоединения
- `is_owner` - Флаг владельца команды

## API для рассылок

После регистрации пользователей через `/start`, их можно использовать для рассылок:

```python
# Пример получения всех пользователей
from app.services.user_service import UserService

users = await UserService.get_all_users(db)
for user in users:
    # Отправить сообщение через Telegram Bot API
    pass
```

## Troubleshooting

### Бот не отвечает:
1. Проверь, что `TELEGRAM_BOT_TOKEN` установлен в `.env`
2. Проверь логи: `docker compose logs backend`
3. Убедись, что миграция применена: `alembic current`

### Ошибка при создании команды:
- Проверь, что пользователь зарегистрирован через `/start`
- Проверь логи базы данных

### Команда не найдена:
- Код команды чувствителен к регистру, но бот автоматически приводит к верхнему регистру
- Убедись, что код введён правильно
