#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∂–µ—Å—Ç–∫–æ–≥–æ pull - –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ—Ç –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

set -e

echo "üîÑ –ñ–µ—Å—Ç–∫–∏–π pull —Å git (–æ—Ç–±—Ä–æ—Å–∏—Ç –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)"

# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ç–∫—É
CURRENT_BRANCH=$(git branch --show-current)
echo "–¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $CURRENT_BRANCH"

# –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
echo ""
echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –í—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã!"
read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (yes/no): " confirm

if [ "$confirm" != "yes" ]; then
    echo "‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ"
    exit 1
fi

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ stash (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
echo ""
echo "üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ stash (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)..."
git stash push -m "Backup before hard pull $(date +%Y-%m-%d_%H:%M:%S)" || true

# –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
echo ""
echo "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
git fetch origin

# –ñ–µ—Å—Ç–∫–∏–π —Å–±—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
echo ""
echo "üîÑ –ñ–µ—Å—Ç–∫–∏–π —Å–±—Ä–æ—Å –Ω–∞ origin/$CURRENT_BRANCH..."
git reset --hard origin/$CURRENT_BRANCH

# –û—á–∏—Å—Ç–∫–∞ –Ω–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
echo ""
read -p "–£–¥–∞–ª–∏—Ç—å –Ω–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã? (yes/no): " clean_untracked

if [ "$clean_untracked" == "yes" ]; then
    echo "üßπ –û—á–∏—Å—Ç–∫–∞ –Ω–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤..."
    git clean -fd
    echo "‚úÖ –ù–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã"
fi

echo ""
echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å origin/$CURRENT_BRANCH"
echo ""
echo "üìã –°—Ç–∞—Ç—É—Å:"
git status

echo ""
echo "üí° –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ stash:"
echo "   git stash list"
echo "   git stash pop"
