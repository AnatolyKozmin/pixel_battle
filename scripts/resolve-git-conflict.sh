#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è git –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

set -e

echo "üîß –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ git –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo "–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å git:"
git status

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–∞—Ä–∫–µ—Ä—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞
CONFLICT_FILES=$(git diff --name-only --diff-filter=U 2>/dev/null || echo "")

if [ -z "$CONFLICT_FILES" ]; then
    echo "‚úÖ –ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –≤ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    MODIFIED_FILES=$(git diff --name-only 2>/dev/null || echo "")
    
    if [ ! -z "$MODIFIED_FILES" ]; then
        echo "‚ö†Ô∏è  –ï—Å—Ç—å –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:"
        echo "$MODIFIED_FILES"
        echo ""
        echo "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
        echo "1. –ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ —Å–¥–µ–ª–∞—Ç—å pull"
        echo "2. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ stash, —Å–¥–µ–ª–∞—Ç—å pull, –≤–µ—Ä–Ω—É—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è"
        echo "3. –û—Ç–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è"
        read -p "–í–∞—à –≤—ã–±–æ—Ä (1/2/3): " choice
        
        case $choice in
            1)
                echo "üìù –ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
                git add -A
                git commit -m "Local changes before pull"
                echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã"
                ;;
            2)
                echo "üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ stash..."
                git stash push -m "Local changes before pull $(date +%Y-%m-%d_%H:%M:%S)"
                echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ stash"
                ;;
            3)
                echo "üîÑ –û—Ç–º–µ–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
                git restore .
                echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω—ã"
                ;;
            *)
                echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä"
                exit 1
                ;;
        esac
    fi
else
    echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã —Ñ–∞–π–ª—ã –≤ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ:"
    echo "$CONFLICT_FILES"
    echo ""
    echo "–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤..."
    
    for file in $CONFLICT_FILES; do
        echo "–û–±—Ä–∞–±–æ—Ç–∫–∞ $file..."
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–∞—Ä–∫–µ—Ä—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞
        if grep -q "<<<<<<< " "$file"; then
            echo "  –ù–∞–π–¥–µ–Ω—ã –º–∞—Ä–∫–µ—Ä—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –≤ $file"
            
            # –î–ª—è docker-compose.ip.yml –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
            if [ "$file" == "docker-compose.ip.yml" ]; then
                echo "  –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –≤ docker-compose.ip.yml..."
                
                # –£–¥–∞–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞, –æ—Å—Ç–∞–≤–ª—è—è –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é
                sed -i.bak '/<<<<<<< /,/>>>>>>> /d' "$file"
                sed -i.bak '/=======/d' "$file"
                
                # –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è —Å—Ç—Ä–æ–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                sed -i.bak '/^# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: docker-compose -f docker-compose.ip.yml up -d$/N;/^# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: docker-compose -f docker-compose.ip.yml up -d\n# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: docker-compose -f docker-compose.ip.yml up -d$/d' "$file"
                
                echo "  ‚úÖ –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
            else
                echo "  ‚ö†Ô∏è  –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –≤ $file"
                echo "  –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç –≤—Ä—É—á–Ω—É—é"
            fi
        fi
    done
    
    echo ""
    echo "–ü–æ—Å–ª–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
    echo "  git add <—Ñ–∞–π–ª—ã>"
    echo "  git commit"
fi

echo ""
echo "üîÑ –ü–æ–ø—ã—Ç–∫–∞ pull..."
if git pull; then
    echo "‚úÖ Pull –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ"
    
    # –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ stash, –ø–æ–ø—Ä–æ–±—É–µ–º –≤–µ—Ä–Ω—É—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
    if git stash list | grep -q "before pull"; then
        echo ""
        echo "üíæ –ü–æ–ø—ã—Ç–∫–∞ –≤–µ—Ä–Ω—É—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ stash..."
        if git stash pop; then
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã"
        else
            echo "‚ö†Ô∏è  –ö–æ–Ω—Ñ–ª–∏–∫—Ç –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ stash"
            echo "–†–∞–∑—Ä–µ—à–∏—Ç–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç –≤—Ä—É—á–Ω—É—é –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: git stash drop"
        fi
    fi
else
    echo "‚ùå Pull –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—à–∏–±–∫–∏ –≤—ã—à–µ."
    exit 1
fi

echo ""
echo "‚úÖ –ì–æ—Ç–æ–≤–æ!"
